# üì± Evolution API - Documentaci√≥n Completa

## üéØ Descripci√≥n del Proyecto

Evolution API es una soluci√≥n completa para integrar WhatsApp Business en aplicaciones, proporcionando endpoints REST para enviar mensajes, gestionar instancias y automatizar conversaciones.

## üèóÔ∏è Arquitectura del Sistema

### **Servicios Desplegados:**
- **Evolution API**: `http://localhost:8081`
- **PostgreSQL Database**: `localhost:5432`
- **Redis Cache**: `localhost:6379`

### **Versi√≥n Actual:**
- Evolution API v2.2.3
- Manager Interface disponible en `/manager`

## üîê Configuraci√≥n de Autenticaci√≥n

### **API Key Authentication:**
```bash
Header: apikey: evolution_api_key_2024
Content-Type: application/json
```

### **Variables de Entorno:**
```bash
AUTHENTICATION_API_KEY=evolution_api_key_2024
AUTHENTICATION_TYPE=apikey
AUTHENTICATION_EXPOSE_IN_FETCH_INSTANCES=true
```

## üì± Gesti√≥n de Instancias WhatsApp

### **Instancias Activas:**

#### **Instancia Principal:**
- **Nombre**: `h`
- **Estado**: `open` (Conectada)
- **WhatsApp ID**: `50763116918@s.whatsapp.net`
- **Instance ID**: `237f6631-d9c5-4587-9698-a5f84f64ccc6`
- **Listo para enviar mensajes**: ‚úÖ

#### **Instancia de Prueba:**
- **Nombre**: `test_instance`
- **Estado**: `close` (Requiere conexi√≥n QR)
- **Instance ID**: `e4aa0861-0aec-40bc-a3c4-5b5c1660abf4`

## üöÄ API Endpoints - Gu√≠a de Uso

### **1. üìù Enviar Mensaje de Texto**

```http
POST http://localhost:8081/message/sendText/{instance}
```

**Headers:**
```json
{
  "apikey": "evolution_api_key_2024",
  "Content-Type": "application/json"
}
```

**Body:**
```json
{
  "number": "50763116918",
  "text": "¬°Hola desde Evolution API! üöÄ"
}
```

**Ejemplo cURL:**
```bash
curl -X POST "http://localhost:8081/message/sendText/h" \
  -H "apikey: evolution_api_key_2024" \
  -H "Content-Type: application/json" \
  -d '{
    "number": "50763116918",
    "text": "¬°Hola desde Evolution API!"
  }'
```

### **2. üñºÔ∏è Enviar Mensaje con Imagen**

```http
POST http://localhost:8081/message/sendMedia/{instance}
```

**Body:**
```json
{
  "number": "50763116918",
  "mediatype": "image",
  "media": "https://picsum.photos/400/300",
  "caption": "Imagen enviada desde Evolution API üì∏"
}
```

**Tipos de Media Soportados:**
- `image` - Im√°genes (JPG, PNG, WEBP)
- `video` - Videos (MP4, AVI, MOV)
- `audio` - Audios (MP3, OGG, WAV)
- `document` - Documentos (PDF, DOC, XLS, etc.)

### **3. üîò Enviar Mensaje con Botones**

```http
POST http://localhost:8081/message/sendButtons/{instance}
```

**Body:**
```json
{
  "number": "50763116918",
  "title": "üéØ Selecciona una opci√≥n",
  "description": "Por favor, elige una de las siguientes opciones:",
  "buttons": [
    {
      "buttonId": "option1",
      "buttonText": {
        "displayText": "‚úÖ Opci√≥n 1"
      },
      "type": "reply"
    },
    {
      "buttonId": "option2",
      "buttonText": {
        "displayText": "üöÄ Opci√≥n 2"
      },
      "type": "reply"
    }
  ]
}
```

### **4. üìã Enviar Lista de Opciones**

```http
POST http://localhost:8081/message/sendList/{instance}
```

**Body:**
```json
{
  "number": "50763116918",
  "title": "üìã Men√∫ de Opciones",
  "description": "Selecciona una opci√≥n del men√∫:",
  "buttonText": "Ver Opciones",
  "footerText": "Evolution API Bot",
  "sections": [
    {
      "title": "üõçÔ∏è Productos",
      "rows": [
        {
          "rowId": "prod1",
          "title": "Producto 1",
          "description": "Descripci√≥n del producto 1"
        },
        {
          "rowId": "prod2",
          "title": "Producto 2", 
          "description": "Descripci√≥n del producto 2"
        }
      ]
    }
  ]
}
```

### **5. üìû Enviar Mensaje de Contacto**

```http
POST http://localhost:8081/message/sendContact/{instance}
```

**Body:**
```json
{
  "number": "50763116918",
  "contact": {
    "fullName": "Juan P√©rez",
    "wuid": "50712345678",
    "phoneNumber": "50712345678"
  }
}
```

### **6. üìç Enviar Ubicaci√≥n**

```http
POST http://localhost:8081/message/sendLocation/{instance}
```

**Body:**
```json
{
  "number": "50763116918",
  "latitude": 9.934739,
  "longitude": -84.087502,
  "name": "San Jos√©, Costa Rica",
  "address": "Centro de San Jos√©"
}
```

## üîç Endpoints de Consulta

### **Estado de Instancia**
```http
GET http://localhost:8081/instance/connectionState/{instance}
```

### **Listar Todas las Instancias**
```http
GET http://localhost:8081/instance/fetchInstances
```

### **Informaci√≥n de la Instancia**
```http
GET http://localhost:8081/instance/find/{instance}
```

### **Obtener QR Code**
```http
GET http://localhost:8081/instance/connect/{instance}
```

## üéõÔ∏è Gesti√≥n de Instancias

### **Crear Nueva Instancia**
```http
POST http://localhost:8081/instance/create
```

**Body:**
```json
{
  "instanceName": "mi_bot_2024",
  "integration": "WHATSAPP-BAILEYS",
  "token": "mi_token_personalizado"
}
```

### **Eliminar Instancia**
```http
DELETE http://localhost:8081/instance/delete/{instance}
```

### **Reiniciar Instancia**
```http
PUT http://localhost:8081/instance/restart/{instance}
```

### **Desconectar Instancia**
```http
DELETE http://localhost:8081/instance/logout/{instance}
```

## üîî Configuraci√≥n de Webhooks

### **Configurar Webhook**
```http
POST http://localhost:8081/webhook/set/{instance}
```

**Body:**
```json
{
  "webhook": {
    "enabled": true,
    "url": "https://tu-servidor.com/webhook",
    "webhookByEvents": true,
    "webhookBase64": false,
    "events": [
      "MESSAGES_UPSERT",
      "MESSAGES_UPDATE", 
      "CONNECTION_UPDATE",
      "PRESENCE_UPDATE",
      "CHATS_UPSERT"
    ]
  }
}
```

### **Obtener Configuraci√≥n de Webhook**
```http
GET http://localhost:8081/webhook/find/{instance}
```

### **Eventos de Webhook Disponibles:**
- `MESSAGES_UPSERT` - Nuevos mensajes recibidos
- `MESSAGES_UPDATE` - Actualizaciones de estado de mensajes
- `CONNECTION_UPDATE` - Cambios en la conexi√≥n de la instancia
- `PRESENCE_UPDATE` - Actualizaciones de presencia (online/offline)
- `CHATS_UPSERT` - Nuevos chats creados
- `CONTACTS_UPSERT` - Nuevos contactos agregados
- `CONTACTS_UPDATE` - Actualizaciones de contactos

## üóÉÔ∏è Base de Datos

### **Esquema PostgreSQL:**
El sistema utiliza m√°s de 30 tablas para gesti√≥n completa:

**Tablas Principales:**
- `Instance` - Gesti√≥n de instancias WhatsApp
- `Message` - Almacenamiento de todos los mensajes
- `Contact` - Informaci√≥n de contactos
- `Chat` - Datos de conversaciones
- `Webhook` - Configuraciones de webhooks
- `Setting` - Configuraciones de instancias
- `Media` - Gesti√≥n de archivos multimedia

### **Consultas de Base de Datos:**
```sql
-- Ver todas las instancias
SELECT * FROM "Instance";

-- Ver mensajes recientes
SELECT * FROM "Message" ORDER BY "createdAt" DESC LIMIT 10;

-- Ver contactos de una instancia
SELECT * FROM "Contact" WHERE "instanceId" = 'tu-instance-id';
```

## üõ†Ô∏è Comandos de Administraci√≥n

### **Comandos Make:**
```bash
# Ver ayuda
make help

# Iniciar proyecto completo
make start

# Estado de servicios  
make status

# Ver logs de Evolution API
make logs-evolution

# Ver logs de PostgreSQL
make logs-postgres

# Detener servicios
make down

# Reiniciar servicios
make restart

# Backup de base de datos
make backup

# Limpiar todo (‚ö†Ô∏è CUIDADO - Elimina datos)
make clean
```

### **Scripts √ötiles:**
```bash
# Obtener QR Code
./get-qr.sh

# Inicializar m√∫ltiples bases de datos
./init-multi-db.sh

# Script de inicio personalizado
./start.sh
```

## üîß Configuraci√≥n Avanzada

### **Variables de Entorno Importantes:**
```bash
# Servidor
SERVER_PORT=8080

# Base de datos
DATABASE_PROVIDER=postgresql
DATABASE_CONNECTION_URI=postgresql://user:pass@localhost:5432/evolutiondb
DATABASE_ENABLED=true

# Redis
CACHE_REDIS_ENABLED=true
CACHE_REDIS_URI=redis://localhost:6379
CACHE_REDIS_PREFIX_KEY=evolution_v2

# CORS
CORS_ORIGIN=*
CORS_METHODS=POST,GET,PUT,DELETE
CORS_CREDENTIALS=true

# L√≠mites
QRCODE_LIMIT=10
```

## üîó Integraciones Disponibles

### **Plataformas Compatibles:**
- **Chatwoot** - Atenci√≥n al cliente
- **OpenAI** - Integraci√≥n con IA
- **Typebot** - Chatbots conversacionales
- **Dify** - Plataforma de IA conversacional
- **Flowise** - Workflows de LangChain
- **Make** (Integromat) - Automatizaci√≥n
- **Zapier** - Conectores de aplicaciones

### **Configuraci√≥n de OpenAI:**
```json
{
  "openaiApiKey": "tu-api-key",
  "model": "gpt-3.5-turbo",
  "systemMessage": "Eres un asistente √∫til para WhatsApp",
  "maxTokens": 1000,
  "temperature": 0.7
}
```

## üß™ Herramienta de Pruebas

### **HTML Tester Incluido:**
üìÅ **Archivo**: `evolution-api-tester.html`

**Caracter√≠sticas:**
- ‚úÖ Interfaz web amigable
- ‚úÖ Prueba de 3 tipos de mensajes
- ‚úÖ Campos editables para personalizaci√≥n
- ‚úÖ Respuestas en tiempo real
- ‚úÖ Validaci√≥n de campos
- ‚úÖ Estados visuales (√©xito/error)

**Uso:**
1. Abrir `evolution-api-tester.html` en el navegador
2. Configurar n√∫mero de destino
3. Personalizar mensajes
4. Hacer clic en los botones para enviar

## üìä Monitoreo y Logs

### **Logs en Tiempo Real:**
```bash
# Todos los servicios
docker-compose logs -f

# Solo Evolution API
docker-compose logs -f evolution-api

# Solo PostgreSQL  
docker-compose logs -f postgres
```

### **Estado de Servicios:**
```bash
# Ver estado actual
docker-compose ps

# Estad√≠sticas de uso
docker stats
```

## üîí Seguridad

### **Mejores Pr√°cticas:**
- ‚úÖ Cambiar API key por defecto
- ‚úÖ Usar HTTPS en producci√≥n
- ‚úÖ Configurar firewall apropiado
- ‚úÖ Hacer backups regulares
- ‚úÖ Monitorear logs de acceso
- ‚úÖ Validar n√∫meros de tel√©fono
- ‚úÖ Implementar rate limiting

### **Configuraci√≥n de Seguridad:**
```bash
# Generar nueva API key
AUTHENTICATION_API_KEY=$(openssl rand -hex 32)

# Configurar CORS espec√≠fico
CORS_ORIGIN=https://tu-dominio.com

# Habilitar logs de seguridad
LOGGER_LEVEL=DEBUG
```

## üö® Troubleshooting

### **Problemas Comunes:**

#### **Error de Conexi√≥n:**
```bash
# Verificar servicios
make status

# Reiniciar servicios
make restart

# Ver logs de errores
make logs
```

#### **Instancia No Conecta:**
```bash
# Obtener nuevo QR
./get-qr.sh

# Verificar estado
curl -H "apikey: evolution_api_key_2024" \
  http://localhost:8081/instance/connectionState/h
```

#### **Base de Datos:**
```bash
# Verificar conexi√≥n PostgreSQL
docker exec -it evolution_postgres psql -U postgres -d evolutiondb -c "\dt"

# Backup de emergencia
make backup
```

## üìö Recursos Adicionales

### **Documentaci√≥n Oficial:**
- üåê **Sitio Web**: https://evolution-api.com
- üìñ **Documentaci√≥n**: https://doc.evolution-api.com
- üêô **GitHub**: https://github.com/EvolutionAPI/evolution-api
- üí¨ **Discord**: https://discord.gg/evolutionapi

### **APIs Relacionadas:**
- **WhatsApp Business API**: https://developers.facebook.com/docs/whatsapp
- **Baileys Library**: https://github.com/WhiskeySockets/Baileys

---

## ‚ú® Casos de Uso Pr√°cticos

### **1. Bot de Atenci√≥n al Cliente**
```javascript
// Respuesta autom√°tica a consultas
const autoResponse = {
  number: customerPhone,
  text: "¬°Hola! Gracias por contactarnos. Un agente te atender√° pronto. üëã"
}
```

### **2. Notificaciones Autom√°ticas**
```javascript
// Notificar eventos del sistema
const notification = {
  number: adminPhone,
  text: `üö® Alerta: ${eventType} - ${eventMessage}`
}
```

### **3. Marketing Personalizado**
```javascript
// Env√≠o masivo con personalizaci√≥n
customers.forEach(customer => {
  const message = {
    number: customer.phone,
    text: `¬°Hola ${customer.name}! üéâ Tenemos ofertas especiales para ti.`
  }
})
```

---

**üéØ Evolution API est√° listo para integrar WhatsApp en tus proyectos. ¬°Comienza a automatizar conversaciones ahora!**

---

*√öltima actualizaci√≥n: Diciembre 2024*
*Versi√≥n: Evolution API v2.2.3*